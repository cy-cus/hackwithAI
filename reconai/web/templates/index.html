<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HackwithAI - AI-Powered Security Recon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hacker-style theme: Matrix terminal aesthetic */
        body {
            background: linear-gradient(135deg, #0a0e0f 0%, #0d1117 50%, #010409 100%);
            background-attachment: fixed;
        }
        body.landing {
            overflow: hidden;
        }
        body:not(.landing) {
            overflow-y: auto;
        }
        body.landing main {
            min-height: calc(100vh - 140px);
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        body.landing .main-grid {
            transform-origin: top center;
        }
        .matrix-layers {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }
        .matrix-layer {
            position: absolute;
            inset: 0;
            opacity: 0.12;
            animation: matrixDrift linear infinite;
        }
        .matrix-layer:nth-child(1) {
            background: repeating-linear-gradient(
                90deg,
                rgba(0, 255, 65, 0.3),
                rgba(0, 255, 65, 0.3) 1px,
                transparent 1px,
                transparent 30px
            );
            animation-duration: 60s;
        }
        .matrix-layer:nth-child(2) {
            background: repeating-linear-gradient(
                rgba(0, 255, 65, 0.15),
                rgba(0, 255, 65, 0.15) 1px,
                transparent 1px,
                transparent 35px
            );
            animation-duration: 90s;
        }
        @keyframes matrixDrift {
            from { transform: translateY(0); }
            to { transform: translateY(200px); }
        }
        @media (max-height: 980px) {
            body.landing .main-grid { transform: scale(0.95); }
        }
        @media (max-height: 900px) {
            body.landing .main-grid { transform: scale(0.92); }
        }
        @media (max-height: 820px) {
            body.landing .main-grid { transform: scale(0.88); }
        }
        @media (max-height: 760px) {
            body.landing .main-grid { transform: scale(0.82); }
        }
        .hidden {
            display: none !important;
        }

        .glass {
            background: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 65, 0.2);
            box-shadow: 0 4px 20px rgba(0, 255, 65, 0.1);
        }
        .glass-light {
            background: rgba(22, 27, 34, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 65, 0.15);
        }

        .advanced-panel {
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: rgba(10, 15, 12, 0.6);
        }

        .advanced-panel summary {
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #9ae6b4;
            list-style: none;
        }

        .advanced-panel summary::-webkit-details-marker {
            display: none;
        }

        .advanced-panel[open] summary {
            color: #00ff41;
        }
        .mode-btn {
            transition: all 0.3s ease;
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 65, 0.3);
        }
        .mode-btn:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: rgba(0, 255, 65, 0.5);
        }
        .mode-btn.active {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            color: #000;
            box-shadow: 0 4px 20px rgba(0, 255, 65, 0.6);
            border-color: #00ff41;
        }
        .mode-btn.active::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #00ff41, #00cc33);
            border-radius: 0.5rem;
            z-index: -1;
            opacity: 0.4;
            filter: blur(10px);
        }
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
        }
        .result-section {
            max-height: 600px;
            overflow-y: auto;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .gradient-text {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }
        /* Targeted scanning styles */
        .item-checkbox {
            accent-color: #00ff41;
        }
        .scan-ai-btn {
            background: linear-gradient(135deg, #ff0080 0%, #cc0066 100%);
            border: 1px solid #ff0080;
            box-shadow: 0 4px 15px rgba(255, 0, 128, 0.4);
            transition: all 0.3s ease;
        }
        .scan-ai-btn:hover {
            box-shadow: 0 6px 25px rgba(255, 0, 128, 0.6);
            transform: translateY(-2px);
        }
        .scan-ai-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .source-tag {
            background: rgba(0, 255, 65, 0.2);
            border: 1px solid rgba(0, 255, 65, 0.4);
            color: #00ff41;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        /* Full-Panel Animated Scanner */
        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scanner-container {
            width: 90%;
            max-width: 1200px;
            padding: 3rem;
        }
        
        .scanner-text {
            font-family: 'Courier New', monospace;
            color: #00ff41;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.8);
        }
        
        .scan-line {
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                #00ff41 20%, 
                #00ff41 80%, 
                transparent 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.8);
        }
        
        .scan-line::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 0, 128, 0.8) 50%, 
                transparent 100%);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { left: -100%; }
            100% { left: 200%; }
        }
        
        .matrix-rain {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.1;
            pointer-events: none;
        }
        
        @keyframes matrix-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        
        .matrix-column {
            position: absolute;
            top: -100%;
            color: #00ff41;
            font-family: monospace;
            font-size: 14px;
            animation: matrix-fall 3s linear infinite;
            white-space: nowrap;
        }
        
        .progress-glow {
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% {
                text-shadow: 
                    0 0 5px #00ff41,
                    0 0 10px #00ff41,
                    0 0 15px #00ff41;
            }
            50% {
                text-shadow: 
                    0 0 10px #00ff41,
                    0 0 20px #00ff41,
                    0 0 30px #00ff41,
                    0 0 40px #00ff41;
            }
        }
        
        .step-line {
            border-left: 2px solid rgba(0, 255, 65, 0.3);
            padding-left: 1rem;
            margin-left: 0.5rem;
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.8);
            animation: pulse 1s infinite;
        }
        
        .tab-btn.active {
            border-bottom-color: #00ff41 !important;
            color: #00ff41 !important;
        }
        
        .tab-btn:hover {
            border-bottom-color: rgba(0, 255, 65, 0.5) !important;
            color: rgba(0, 255, 65, 0.7) !important;
        }
        .terminal-text {
            font-family: 'Courier New', monospace;
            color: #00ff41;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }
        .neon-border {
            border: 1px solid #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        .critical-tag {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: #ff4444;
        }

        .empty-state-panel {
            min-height: calc(100vh - 240px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: visible;
        }

        .empty-state-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(rgba(0, 255, 65, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 255, 65, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
            pointer-events: none;
            animation: gridScroll 20s linear infinite;
        }

        @keyframes gridScroll {
            from { background-position: 0 0, 0 0; }
            to { background-position: 0 40px, 40px 0; }
        }

        .empty-state-terminal {
            font-family: 'Courier New', monospace;
            color: #00ff41;
            text-shadow: 0 0 15px rgba(0, 255, 65, 0.6);
        }

        .empty-state-lines span {
            display: block;
            margin-bottom: 0.35rem;
            color: rgba(0, 255, 65, 0.8);
        }

        .scan-badge {
            border: 1px solid rgba(0, 255, 65, 0.4);
            background: rgba(0, 0, 0, 0.4);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .scan-header {
            display: inline-flex;
            align-items: center;
            font-size: 1.1rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }
        
        .scan-action-text {
            font-size: 0.9rem;
            letter-spacing: 0.35em;
            text-transform: uppercase;
            color: #00ff41;
        }
        
        .ai-placeholder {
            position: relative;
            overflow: hidden;
        }
        
        .ai-core {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 65, 0.5);
            margin: 0 auto 1.5rem;
            position: relative;
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.4), inset 0 0 20px rgba(0, 255, 65, 0.3);
            animation: rotatePulse 6s linear infinite;
        }
        
        .ai-core::after {
            content: '';
            position: absolute;
            inset: 15px;
            border-radius: 50%;
            border: 1px dashed rgba(255, 0, 128, 0.4);
            animation: rotatePulse 4s linear infinite reverse;
        }
        
        @keyframes rotatePulse {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(180deg) scale(1.05); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-particles span {
            display: inline-block;
            font-family: 'Courier New', monospace;
            color: rgba(0, 255, 65, 0.7);
            margin-right: 0.35rem;
            animation: flicker 2s infinite;
        }
        
        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 24%, 55% { opacity: 0.2; }
        }
        
        /* Enhanced hacker UI effects */
        .glitch {
            position: relative;
            animation: glitch 3s infinite;
        }
        
        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); }
            92% { transform: translate(-2px, 2px); }
            94% { transform: translate(2px, -2px); }
            96% { transform: translate(-2px, -2px); }
        }
        
        .scan-btn-enhanced {
            position: relative;
            overflow: hidden;
        }
        
        .scan-btn-enhanced::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(0, 255, 65, 0.3) 50%, 
                transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .terminal-cursor::after {
            content: '‚ñä';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .glass-enhanced {
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0, 255, 65, 0.3);
            box-shadow: 
                0 0 20px rgba(0, 255, 65, 0.2),
                inset 0 0 20px rgba(0, 255, 65, 0.05);
            position: relative;
        }
        
        .glass-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 255, 65, 0.5) 50%, 
                transparent 100%);
        }
        
        .hacker-button {
            background: linear-gradient(135deg, #001a00 0%, #003300 100%);
            border: 1px solid #00ff41;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.8);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
            transition: all 0.3s ease;
        }
        
        .hacker-button:hover {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.6);
            transform: translateY(-2px);
        }
        .high-tag {
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid rgba(255, 165, 0, 0.5);
            color: #ffaa44;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <div class="matrix-layers">
        <div class="matrix-layer"></div>
        <div class="matrix-layer"></div>
    </div>

    <!-- Header -->
    <header class="glass-enhanced border-b border-green-500 shadow-lg relative z-10">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-4xl glitch">ü¶Ö</span>
                    <div>
                        <h1 class="text-3xl font-bold gradient-text glitch terminal-cursor">HackwithAI</h1>
                        <p class="text-green-400 text-sm terminal-text">[ SYSTEM ACTIVE ] HackwithAI Recon Suite</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="homeViewBtn" class="hacker-button px-4 py-2 rounded-lg font-bold text-sm">
                        üè† HOME
                    </button>
                    <button id="loadScanBtn" class="hacker-button px-4 py-2 rounded-lg font-bold text-sm">
                        üìÇ LOAD SCAN
                    </button>
                    <button id="modelsBtn" class="hacker-button px-4 py-2 rounded-lg font-bold text-sm">
                        ü§ñ MODELS
                    </button>
                    <a href="/docs" target="_blank" class="hacker-button px-4 py-2 rounded-lg font-bold text-sm">
                        üì° API DOCS
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Full-Panel Animated Scanner (Initially hidden) -->
    <div id="scannerOverlay" class="scanner-overlay hidden">
        <div class="scanner-container">
            <!-- Matrix Rain Effect -->
            <div class="matrix-rain" id="matrixRain"></div>
            
            <!-- Scanner Content -->
            <div class="relative z-10">
                <!-- Title -->
                <h2 class="text-5xl font-bold text-center mb-8 scanner-text progress-glow">
                    <span id="scannerTitle">üîç SCANNING TARGET</span>
                </h2>
                
                <!-- Progress Bar -->
                <div class="mb-8">
                    <div class="w-full bg-black rounded-lg h-8 overflow-hidden border border-green-500">
                        <div id="scannerProgressBar" 
                             class="h-full bg-gradient-to-r from-green-500 via-green-400 to-green-500 transition-all duration-500"
                             style="width: 0%">
                        </div>
                    </div>
                    <div class="flex justify-between mt-2">
                        <span class="scanner-text text-sm" id="scannerPercentage">0%</span>
                        <span class="scanner-text text-sm" id="scannerStatus">Initializing...</span>
                    </div>
                </div>
                
                <!-- Animated Scan Line -->
                <div class="scan-line mb-8"></div>
                
                <!-- Current Step -->
                <div class="text-center mb-8">
                    <p class="scanner-text text-2xl font-mono" id="scannerMessage">
                        Preparing reconnaissance modules...
                    </p>
                </div>
                
                <!-- Steps Timeline -->
                <div class="step-line space-y-3 max-h-64 overflow-y-auto" id="scannerSteps">
                    <!-- Steps will be added here dynamically -->
                </div>
                
                <!-- Stats Counter -->
                <div class="grid grid-cols-5 gap-4 mt-8">
                    <div class="text-center glass-light rounded-lg p-3">
                        <div class="text-3xl font-bold text-green-400" id="scanner-stat-subdomains">0</div>
                        <div class="text-xs text-gray-400">Subdomains</div>
                    </div>
                    <div class="text-center glass-light rounded-lg p-3">
                        <div class="text-3xl font-bold text-green-400" id="scanner-stat-urls">0</div>
                        <div class="text-xs text-gray-400">URLs</div>
                    </div>
                    <div class="text-center glass-light rounded-lg p-3">
                        <div class="text-3xl font-bold text-green-400" id="scanner-stat-endpoints">0</div>
                        <div class="text-xs text-gray-400">Endpoints</div>
                    </div>
                    <div class="text-center glass-light rounded-lg p-3">
                        <div class="text-3xl font-bold text-green-400" id="scanner-stat-js">0</div>
                        <div class="text-xs text-gray-400">JS Files</div>
                    </div>
                    <div class="text-center glass-light rounded-lg p-3">
                        <div class="text-3xl font-bold text-pink-400" id="scanner-stat-secrets">0</div>
                        <div class="text-xs text-gray-400">Secrets</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <main class="container mx-auto px-6 py-8 relative z-10">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 main-grid">
            <!-- Left Panel - Scan Form & Controls -->
            <div class="xl:col-span-3 space-y-6">
                <!-- Scan Form -->
                <div class="glass-enhanced rounded-lg shadow-xl p-6">
                    
                    <!-- Mode Selector -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-3 text-gray-300">Scan Mode</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" class="mode-btn active px-2 py-1 rounded-lg text-xs font-medium transition" data-mode="domain">
                                üåê Single
                            </button>
                            <button type="button" class="mode-btn glass-light px-2 py-1 rounded-lg text-xs font-medium transition" data-mode="domains">
                                üåç Multiple
                            </button>
                            <button type="button" class="mode-btn glass-light px-2 py-1 rounded-lg text-xs font-medium transition" data-mode="js_files">
                                üìÑ JS Only
                            </button>
                        </div>
                    </div>

                    <form id="scanForm" class="space-y-4">
                        <!-- Single Domain Input -->
                        <div id="singleDomainInput" class="input-group">
                            <label class="block text-sm font-medium mb-2 text-gray-300">Target Domain/URL</label>
                            <input type="text" id="target"
                                class="w-full px-4 py-2 glass-light rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition"
                                placeholder="example.com">
                        </div>

                        <!-- Multiple Domains Input -->
                        <div id="multipleDomainsInput" class="input-group hidden">
                            <label class="block text-sm font-medium mb-2 text-gray-300">Target Domains (one per line)</label>
                            <textarea id="targets" rows="5"
                                class="w-full px-4 py-2 glass-light rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition font-mono text-sm"
                                placeholder="example.com&#10;test.com&#10;site.com"></textarea>
                            <p class="text-xs text-gray-400 mt-1">üí° Enter one domain per line</p>
                        </div>

                        <!-- JS Files Input -->
                        <div id="jsFilesInput" class="input-group hidden">
                            <label class="block text-sm font-medium mb-2 text-gray-300">JavaScript File URLs (one per line)</label>
                            <textarea id="jsUrls" rows="5"
                                class="w-full px-4 py-2 glass-light rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition font-mono text-sm"
                                placeholder="https://example.com/app.js&#10;https://example.com/bundle.min.js"></textarea>
                            <p class="text-xs text-gray-400 mt-1">üí° Skips domain enumeration, goes straight to JS analysis</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-300">ü§ñ AI Model</label>
                            <select id="model" class="w-full px-4 py-2 glass-light rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition">
                                <option value="llama3.1:8b">Llama 3.1 8B</option>
                                <option value="mistral-nemo:12b">Mistral Nemo 12B</option>
                                <option value="deepseek-coder:6.7b">DeepSeek Coder 6.7B</option>
                                <option value="deepseek-coder:1.3b">DeepSeek Coder 1.3B</option>
                            </select>
                        </div>
                        <div id="jsSizeOption">
                            <label class="block text-sm font-medium mb-2 text-gray-300">üìä JS Analysis Size</label>
                            <select id="jsSizeFilter" class="w-full px-4 py-2 glass-light rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none transition">
                                <option value="small">Small (first 100 JS files)</option>
                                <option value="medium" selected>Medium (first 1000 JS files)</option>
                                <option value="large">Large (all JS files)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="skipLlm" class="rounded glass-light border-gray-600 cursor-pointer">
                                <span class="text-sm text-gray-300">‚ö° Skip AI Analysis (faster)</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="skipSubfinder" class="rounded glass-light border-gray-600 cursor-pointer">
                                <span class="text-sm text-gray-300">üéØ Skip Subdomain Discovery</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="runNuclei" class="rounded glass-light border-gray-600 cursor-pointer">
                                <span class="text-sm text-gray-300">üí£ Run Nuclei (vulnerability scan)</span>
                            </label>
                        </div>
                        <button type="submit" id="scanBtn"
                            class="w-full scan-btn-enhanced bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-black font-bold py-2 px-5 rounded-lg text-sm transition transform hover:scale-105 shadow-lg relative z-10">
                            <span class="relative z-10 scan-action-text">INITIATE</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Middle Panel - Results & Chat -->
            <div class="xl:col-span-6 space-y-6">
                <!-- Results Tabs -->
                <div id="resultsPanel" class="glass rounded-lg shadow-xl hidden">
                    <!-- Tabs -->
                    <div class="border-b border-gray-700">
                        <div class="flex space-x-4 px-6 pt-4">
                            <button class="tab-btn active px-4 py-2 font-medium border-b-2 border-green-500 text-green-400" data-tab="findings">
                                Findings
                            </button>
                            <button class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-gray-600 text-gray-400" data-tab="secrets">
                                Secrets
                            </button>
                            <button class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-gray-600 text-gray-400" data-tab="urls">
                                URLs
                            </button>
                            <button class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-gray-600 text-gray-400" data-tab="endpoints">
                                Endpoints
                            </button>
                            <button class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-gray-600 text-gray-400" data-tab="jsfiles">
                                JS Files
                            </button>
                            <button class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-gray-600 text-gray-400" data-tab="nuclei">
                                Nuclei
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="p-6">
                        <!-- Findings Tab -->
                        <div id="tab-findings" class="tab-content result-section">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">üîç Security Findings</h3>
                                <button id="scanFindingsBtn" class="scan-ai-btn px-4 py-2 rounded-lg font-bold text-white disabled:opacity-50" disabled>
                                    ü§ñ Scan Selected with AI
                                </button>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="findingSearch" placeholder="üîç Search findings..." 
                                    class="w-full px-4 py-2 glass-light rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none text-white mb-3">
                            </div>
                            <div class="mb-3 flex items-center space-x-3">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="selectAllFindings" class="item-checkbox">
                                    <span class="text-sm text-gray-400">Select All</span>
                                </label>
                                <span id="selectedFindingsCount" class="text-sm text-gray-400"></span>
                            </div>
                            <div id="findingsList" class="space-y-3">
                                <!-- Findings will be added here -->
                            </div>
                        </div>

                        <!-- Secrets Tab -->
                        <div id="tab-secrets" class="tab-content result-section hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">üîí Secrets & Sensitive Data</h3>
                                <button id="scanSecretsBtn" class="scan-ai-btn px-4 py-2 rounded-lg font-bold text-white disabled:opacity-50" disabled>
                                    ü§ñ Scan Selected with AI
                                </button>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="secretSearch" placeholder="üîç Search secrets..." 
                                    class="w-full px-4 py-2 glass-light rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none text-white mb-3">
                            </div>
                            <div class="mb-3 flex items-center space-x-3">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="selectAllSecrets" class="item-checkbox">
                                    <span class="text-sm text-gray-400">Select All</span>
                                </label>
                                <span id="selectedSecretsCount" class="text-sm text-gray-400"></span>
                            </div>
                            <div id="secretsList" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Secrets will be added here with checkboxes and source info -->
                            </div>
                        </div>

                        <!-- URLs Tab -->
                        <div id="tab-urls" class="tab-content result-section hidden">
                            <h3 class="text-lg font-bold mb-4">üîó Discovered URLs</h3>
                            <p class="text-sm text-gray-400 mb-3">Full URLs from waybackurls, katana, and httpx</p>
                            <div class="mb-4">
                                <input type="text" id="urlSearch" placeholder="üîç Search URLs..." 
                                    class="w-full px-4 py-2 glass-light rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none text-white">
                            </div>
                            <div id="urlsList" class="space-y-2 font-mono text-sm max-h-96 overflow-y-auto">
                                <!-- URLs will be added here -->
                            </div>
                        </div>

                        <!-- Endpoints Tab -->
                        <div id="tab-endpoints" class="tab-content result-section hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">üéØ API Endpoints</h3>
                                <button id="scanEndpointsBtn" class="scan-ai-btn px-4 py-2 rounded-lg font-bold text-white disabled:opacity-50" disabled>
                                    ü§ñ Scan Selected with AI
                                </button>
                            </div>
                            <p class="text-sm text-gray-400 mb-3">API paths extracted from URLs and JS files</p>
                            <div class="mb-3">
                                <input type="text" id="endpointSearch" placeholder="üîç Search endpoints..." 
                                    class="w-full px-4 py-2 glass-light rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none text-white mb-3">
                            </div>
                            <div class="mb-3 flex items-center space-x-3">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="selectAllEndpoints" class="item-checkbox">
                                    <span class="text-sm text-gray-400">Select All</span>
                                </label>
                                <span id="selectedEndpointsCount" class="text-sm text-gray-400"></span>
                            </div>
                            <div id="endpointsList" class="space-y-2 font-mono text-sm max-h-96 overflow-y-auto">
                                <!-- API endpoint paths will be added here with checkboxes -->
                            </div>
                        </div>

                        <!-- JS Files Tab -->
                        <div id="tab-jsfiles" class="tab-content result-section hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">üìú JavaScript Files</h3>
                                <button id="scanJsFilesBtn" class="scan-ai-btn px-4 py-2 rounded-lg font-bold text-white disabled:opacity-50" disabled>
                                    ü§ñ Scan Selected with AI
                                </button>
                            </div>
                            <p class="text-sm text-gray-400 mb-3">Discovered JS files from the target domain and its subdomains</p>
                            <div class="mb-3">
                                <input type="text" id="jsFileSearch" placeholder="üîç Search JS files..." 
                                    class="w-full px-4 py-2 glass-light rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none text-white mb-3">
                            </div>
                            <div class="mb-3 flex items-center space-x-3">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="selectAllJsFiles" class="item-checkbox">
                                    <span class="text-sm text-gray-400">Select All</span>
                                </label>
                                <span id="selectedJsFilesCount" class="text-sm text-gray-400"></span>
                            </div>
                            <div id="jsFilesList" class="space-y-2 font-mono text-sm max-h-96 overflow-y-auto">
                                <!-- JS files will be added here -->
                            </div>
                        </div>

                        <!-- Nuclei Tab -->
                        <div id="tab-nuclei" class="tab-content result-section hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">üí£ Nuclei Vulnerabilities</h3>
                                <button id="runNucleiBtn" class="scan-ai-btn px-4 py-2 rounded-lg font-bold text-white">
                                    üöÄ Run Nuclei Scan
                                </button>
                            </div>
                            <p class="text-sm text-gray-400 mb-3">Vulnerability scan results from Nuclei templates</p>
                            <div id="nucleiStats" class="grid grid-cols-4 gap-3 mb-4 hidden">
                                <div class="glass-light p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-red-400" id="nucleiCritical">0</div>
                                    <div class="text-xs text-gray-400">Critical</div>
                                </div>
                                <div class="glass-light p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-orange-400" id="nucleiHigh">0</div>
                                    <div class="text-xs text-gray-400">High</div>
                                </div>
                                <div class="glass-light p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-yellow-400" id="nucleiMedium">0</div>
                                    <div class="text-xs text-gray-400">Medium</div>
                                </div>
                                <div class="glass-light p-3 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-400" id="nucleiLow">0</div>
                                    <div class="text-xs text-gray-400">Low</div>
                                </div>
                            </div>
                            <div id="nucleiList" class="space-y-3">
                                <p class="text-gray-400">No Nuclei scan performed yet. Click "Run Nuclei Scan" to start.</p>
                            </div>
                        </div>

                    </div> <!-- End tab content -->
                </div> <!-- End results panel -->

                <!-- Floating Chat Button -->
                <button id="openChatBtn" class="fixed bottom-6 right-6 w-14 h-14 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-40 transition-transform hover:scale-110 hidden">
                    üí¨
                </button>

                <!-- Chat Modal (floating) -->
                <div id="chatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-gray-900 rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col border border-gray-700">
                        <div class="flex items-center justify-between p-4 border-b border-gray-700">
                            <h3 class="text-lg font-bold">üí¨ Chat with HackwithAI</h3>
                            <button id="closeChatModal" class="text-gray-400 hover:text-white text-xl">
                                ‚úï
                            </button>
                        </div>
                        <div class="flex-1 overflow-hidden flex flex-col">
                            <div class="flex items-center justify-between p-3 border-b border-gray-700">
                                <button id="clearChatBtn" class="text-xs text-gray-400 hover:text-green-400 transition">
                                    üóëÔ∏è Clear History
                                </button>
                            </div>
                            <div id="chatMessages" class="flex-1 space-y-3 overflow-y-auto p-4">
                                <div class="glass-light p-4 rounded-lg border border-gray-600">
                                    <p class="text-gray-400 text-sm">Ask questions about your scan results. For example:</p>
                                    <ul class="list-disc list-inside text-gray-400 text-sm mt-2">
                                        <li>What are the most critical findings?</li>
                                        <li>Which secrets pose the highest risk?</li>
                                        <li>Summarize the attack surface</li>
                                    </ul>
                                </div>
                            </div>
                            <form id="chatForm" class="flex space-x-2 items-end p-4 border-t border-gray-700">
                                <div class="flex-1">
                                    <textarea id="chatInput" required rows="2"
                                        class="w-full px-4 py-3 glass-light border border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none resize-none terminal-text"
                                        placeholder="Ask a question about the scan results..."></textarea>
                                </div>
                                <button type="submit" id="chatSendBtn" class="hacker-button px-6 py-3 rounded-lg font-bold text-sm whitespace-nowrap">
                                    ‚ñ∂ SEND
                                </button>
                                <button type="button" id="chatStopBtn" class="hacker-button px-6 py-3 rounded-lg font-bold text-sm whitespace-nowrap hidden" style="background: linear-gradient(135deg, #ff0080 0%, #cc0066 100%);">
                                    ‚èπ STOP
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="glass-enhanced rounded-lg shadow-xl p-0 empty-state-panel text-center">
                    <div class="empty-state-grid"></div>
                    <div class="relative z-10 px-10 py-12 w-full">
                        <div class="text-7xl mb-6 animate-pulse-custom">ü¶Ö</div>
                        <div class="scan-badge inline-flex items-center space-x-2 mb-6">
                            <span class="text-green-400">[ STATUS ]</span>
                            <span class="text-pink-400">IDLE / READY</span>
                        </div>
                        <h3 class="text-4xl font-bold mb-4 gradient-text empty-state-terminal glitch">
                            SYSTEM STANDING BY
                        </h3>
                        <p class="text-gray-300 text-lg mb-6">
                            Select a scan mode and feed targets to deploy reconnaissance modules
                        </p>
                        
                        <div class="grid grid-cols-3 gap-4 text-sm empty-state-lines text-left max-w-4xl mx-auto">
                            <div class="glass-light p-4 rounded-lg border border-gray-700">
                                <span class="text-green-400 font-bold">üåê SINGLE DOMAIN</span>
                                <span>‚Ü≥ Full recon with subdomain discovery</span>
                                <span>‚Ü≥ Ideal for a dedicated target</span>
                            </div>
                            <div class="glass-light p-4 rounded-lg border border-gray-700">
                                <span class="text-green-400 font-bold">üåç MULTIPLE DOMAINS</span>
                                <span>‚Ü≥ Bulk scan multiple targets</span>
                                <span>‚Ü≥ Shared configuration pipeline</span>
                            </div>
                            <div class="glass-light p-4 rounded-lg border border-gray-700">
                                <span class="text-green-400 font-bold">üìÑ JS ONLY</span>
                                <span>‚Ü≥ Direct JavaScript analysis</span>
                                <span>‚Ü≥ Perfect for script drops</span>
                            </div>
                        </div>
                        
                        <div class="mt-8 text-sm terminal-text">
                            <p class="text-pink-400">[ HINT ] Drag & drop targets, load previous scans, or fire a fresh recon sweep.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Progress & Stats (moved here) -->
            <div class="xl:col-span-3 space-y-6">
                <!-- Placeholder before scan results -->
                <div id="rightPlaceholder" class="glass-enhanced rounded-lg p-6 ai-placeholder text-center">
                    <div class="ai-core"></div>
                    <div class="terminal-text text-sm text-pink-400 mb-4">[ AI CORE IDLING - AWAITING TASKING ]</div>
                    <div class="ai-particles text-left text-xs grid grid-cols-2 gap-2">
                        <span>\> Boot diagnostics ... OK</span>
                        <span>\> AI context cache ... READY</span>
                        <span>\> Recon modules ... ONLINE</span>
                        <span>\> Target buffer ... EMPTY</span>
                    </div>
                </div>

                <!-- Progress Panel -->
                <div id="progressPanelRight" class="glass rounded-lg shadow-xl p-6 hidden">
                    <h3 class="text-lg font-bold mb-4 text-green-400">‚ö° Progress</h3>
                    <div class="mb-4">
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="progressBarRight" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progressTextRight" class="text-xs text-gray-400 mt-2">Initializing...</p>
                    </div>
                    <div id="progressStepsRight" class="space-y-1 text-xs max-h-64 overflow-y-auto">
                        <!-- Progress steps -->
                    </div>
                </div>

                <!-- Stats Panel -->
                <div id="statsPanelRight" class="glass rounded-lg shadow-xl p-6 hidden sticky top-6">
                    <h3 class="text-lg font-bold mb-4 text-green-400">üìä Summary</h3>
                    <div class="space-y-3">
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-2xl font-bold text-green-400" id="stat-subdomains-right">0</div>
                            <div class="text-xs text-gray-400">Subdomains</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-2xl font-bold text-green-400" id="stat-urls-right">0</div>
                            <div class="text-xs text-gray-400">URLs</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-2xl font-bold text-green-400" id="stat-endpoints-right">0</div>
                            <div class="text-xs text-gray-400">Endpoints</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-2xl font-bold text-yellow-400" id="stat-js-right">0</div>
                            <div class="text-xs text-gray-400">JS Files</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-2xl font-bold text-red-400" id="stat-secrets-right">0</div>
                            <div class="text-xs text-gray-400">Secrets</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Models Modal -->
    <div id="modelsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-green-400">Available Models</h2>
                <button id="closeModal" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div id="modelsList" class="space-y-2 max-h-96 overflow-y-auto">
                <p class="text-gray-400">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Targeted Scan Results Modal -->
    <div id="targetedScanModal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50">
        <div class="glass neon-border rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold gradient-text">ü§ñ Targeted AI Analysis</h2>
                <button id="closeTargetedModal" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>
            
            <!-- Loading State -->
            <div id="targetedScanLoading" class="text-center py-12">
                <div class="animate-pulse-custom text-6xl mb-4">üîç</div>
                <p class="terminal-text text-lg">Analyzing selected items with AI...</p>
                <p class="text-gray-400 text-sm mt-2">This may take a few moments</p>
            </div>
            
            <!-- Results State -->
            <div id="targetedScanResults" class="hidden">
                <div class="mb-4 p-4 glass-light rounded-lg">
                    <h3 class="font-bold text-lg mb-2 terminal-text">Analysis Summary</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-400">Items Analyzed:</span>
                            <span id="targetedItemsCount" class="terminal-text font-bold ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-gray-400">JS Files Scanned:</span>
                            <span id="targetedJsCount" class="terminal-text font-bold ml-2">0</span>
                        </div>
                    </div>
                    <div id="targetedJsFiles" class="mt-3 text-xs">
                        <!-- JS files list will be added here -->
                    </div>
                </div>
                
                <div class="bg-black bg-opacity-50 p-6 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-lg mb-4 terminal-text">üîç Security Analysis</h3>
                    <div id="targetedAnalysisContent" class="prose prose-invert max-w-none">
                        <!-- Analysis content will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Previous Scan Modal -->
    <div id="loadScanModal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50">
        <div class="glass-enhanced neon-border rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold gradient-text terminal-text glitch">[ üìÇ LOAD PREVIOUS SCAN ]</h2>
                <button id="closeLoadScanModal" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
            </div>
            
            <p class="terminal-text text-sm mb-4">[ SELECT SCAN FROM ARCHIVE ]</p>
            
            <!-- Scan List -->
            <div id="previousScansList" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-center py-8 text-gray-400">
                    <div class="animate-pulse-custom text-4xl mb-2">‚è≥</div>
                    <p>Loading scans...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.body.classList.add('landing');
        const landingSections = [
            document.getElementById('emptyState'),
            document.getElementById('rightPlaceholder')
        ];
        const resultSections = [
            document.getElementById('resultsPanel'),
            document.getElementById('statsPanelRight')
        ];

        function showLandingView() {
            landingSections.forEach(el => el?.classList.remove('hidden'));
            resultSections.forEach(el => el?.classList.add('hidden'));
            document.getElementById('progressPanelRight')?.classList.add('hidden');
            document.body.classList.add('landing');
        }

        function showResultsView() {
            landingSections.forEach(el => el?.classList.add('hidden'));
            document.getElementById('rightPlaceholder')?.classList.add('hidden');
            resultSections.forEach(el => el?.classList.remove('hidden'));
            document.getElementById('openChatBtn')?.classList.remove('hidden');
            document.body.classList.remove('landing');
        }
        
        document.getElementById('homeViewBtn').addEventListener('click', showLandingView);
        let currentScanId = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'border-green-500', 'text-green-400');
                    b.classList.add('border-transparent', 'text-gray-400');
                });
                btn.classList.add('active', 'border-green-500', 'text-green-400');
                btn.classList.remove('border-transparent', 'text-gray-400');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            });
        });

        // Models modal
        document.getElementById('modelsBtn').addEventListener('click', async () => {
            document.getElementById('modelsModal').classList.remove('hidden');
            try {
                const res = await fetch('/api/models');
                const data = await res.json();
                document.getElementById('modelsList').innerHTML = data.models.map(m =>
                    `<div class="bg-gray-700 p-3 rounded">${m}</div>`
                ).join('');
            } catch (e) {
                document.getElementById('modelsList').innerHTML = '<p class="text-red-400">Error loading models</p>';
            }
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('modelsModal').classList.add('hidden');
        });

        // Scan form
        // Scan running state
        let scanRunning = false;
        let currentMode = 'domain'; // Track current scan mode
        
        // Mode selector logic
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentMode = btn.dataset.mode;
                
                // Update active button
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.add('glass-light');
                });
                btn.classList.add('active');
                btn.classList.remove('glass-light');
                
                // Show/hide appropriate inputs
                document.getElementById('singleDomainInput').classList.add('hidden');
                document.getElementById('multipleDomainsInput').classList.add('hidden');
                document.getElementById('jsFilesInput').classList.add('hidden');
                document.getElementById('jsBaseUrlsInput').classList.add('hidden');
                
                if (currentMode === 'domain') {
                    document.getElementById('singleDomainInput').classList.remove('hidden');
                    document.getElementById('jsBaseUrlsInput').classList.remove('hidden');
                } else if (currentMode === 'domains') {
                    document.getElementById('multipleDomainsInput').classList.remove('hidden');
                    document.getElementById('jsBaseUrlsInput').classList.remove('hidden');
                } else if (currentMode === 'js_files') {
                    document.getElementById('jsFilesInput').classList.remove('hidden');
                    // JS base URLs not shown in js_files mode
                }
            });
        });
        
        // Restore last scan id on page load so chat can work after refresh
        window.addEventListener('load', () => {
            const savedScanId = sessionStorage.getItem('currentScanId');
            if (savedScanId) {
                currentScanId = savedScanId;
            }
        });
        
        // Warn before page refresh
        window.addEventListener('beforeunload', (e) => {
            if (scanRunning) {
                const message = '‚ö†Ô∏è Scan in progress! You will lose the progress view.\n\nThe scan continues in the background.\n\nRefresh to reconnect.';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });
        
        document.getElementById('scanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const model = document.getElementById('model').value;
            const skipLlm = document.getElementById('skipLlm').checked;
            const skipSubfinder = document.getElementById('skipSubfinder').checked;
            const runNuclei = document.getElementById('runNuclei').checked;
            const jsSizeFilter = document.getElementById('jsSizeFilter')?.value || 'medium';
            
            // Get manual JS base URLs (if provided)
            const jsBaseUrls = [];
            
            // Build request based on mode
            let requestBody = {
                scan_mode: currentMode,
                model,
                skip_llm: skipLlm,
                skip_subfinder: skipSubfinder,
                run_nuclei: runNuclei,
                nuclei_severity: ["critical", "high", "medium"],
                js_size: jsSizeFilter,
                js_base_urls: jsBaseUrls
            };
            
            if (currentMode === 'domain') {
                const target = document.getElementById('target').value.trim();
                if (!target) {
                    alert('Please enter a target domain');
                    return;
                }
                requestBody.target = target;
            } else if (currentMode === 'domains') {
                const targetsText = document.getElementById('targets').value.trim();
                if (!targetsText) {
                    alert('Please enter at least one domain');
                    return;
                }
                requestBody.targets = targetsText.split('\n').map(t => t.trim()).filter(t => t);
            } else if (currentMode === 'js_files') {
                const jsUrlsText = document.getElementById('jsUrls').value.trim();
                if (!jsUrlsText) {
                    alert('Please enter at least one JS file URL');
                    return;
                }
                requestBody.js_urls = jsUrlsText.split('\n').map(u => u.trim()).filter(u => u);
            }
            
            try {
                const res = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                const data = await res.json();
                
                if (data.scan_id) {
                    // Store scan_id for chat & reconnection
                    currentScanId = data.scan_id;
                    sessionStorage.setItem('currentScanId', data.scan_id);
                    scanRunning = true;
                    
                    // Show full-screen scanner overlay
                    document.getElementById('scannerOverlay').classList.remove('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                    document.getElementById('scanBtn').disabled = true;
                    
                    // Initialize matrix rain effect
                    createMatrixRain();
                    
                    // Connect WebSocket for updates
                    monitorScan(data.scan_id);
                } else {
                    throw new Error('No scan_id returned');
                }
            } catch (error) {
                alert('Error starting scan: ' + error.message);
                document.getElementById('scanBtn').disabled = false;
            }
        });

        function monitorScan(scanId) {
            const ws = new WebSocket(`ws://${window.location.host}/ws/scan/${scanId}`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // Update scanner overlay
                document.getElementById('scannerProgressBar').style.width = data.progress + '%';
                document.getElementById('scannerPercentage').textContent = data.progress + '%';
                document.getElementById('scannerMessage').textContent = data.message;
                document.getElementById('scannerStatus').textContent = data.current_step || 'Processing...';
                
                // Add step to timeline
                if (data.current_step) {
                    const stepsDiv = document.getElementById('scannerSteps');
                    const stepEl = document.createElement('div');
                    stepEl.className = 'flex items-center space-x-2 scanner-text text-sm';
                    stepEl.innerHTML = `
                        <div class="step-dot"></div>
                        <span>${data.current_step}: ${data.message}</span>
                    `;
                    stepsDiv.appendChild(stepEl);
                    stepsDiv.scrollTop = stepsDiv.scrollHeight;
                }
                
                if (data.status === 'completed') {
                    scanRunning = false;
                    ws.close();
                    loadResults(scanId);
                    sessionStorage.setItem('currentScanId', scanId);
                } else if (data.status === 'failed') {
                    scanRunning = false;
                    ws.close();
                    alert('Scan failed: ' + data.message);
                    document.getElementById('scanBtn').disabled = false;
                }
            };
        }

        async function loadResults(scanId) {
            try {
                const res = await fetch(`/api/scan/${scanId}/result`);
                const data = await res.json();
                
                // Ensure chat knows which scan to use
                currentScanId = scanId;
                
                // Update stats
                document.getElementById('stat-subdomains-right').textContent = data.result.total_subdomains || 0;
                document.getElementById('stat-urls-right').textContent = data.result.total_urls || 0;
                document.getElementById('stat-endpoints-right').textContent = data.result.total_api_endpoints || 0;
                document.getElementById('stat-js-right').textContent = data.result.total_js_files || 0;
                document.getElementById('stat-secrets-right').textContent = data.result.total_secrets || 0;
                
                // Hide scanner overlay and show results
                document.getElementById('scannerOverlay').classList.add('hidden');
                document.getElementById('statsPanelRight').classList.remove('hidden');
                document.getElementById('resultsPanel').classList.remove('hidden');
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('rightPlaceholder')?.classList.add('hidden');
                document.getElementById('openChatBtn')?.classList.remove('hidden');
                document.body.classList.remove('landing');
                
                // Update scanner stats (also update right panel)
                document.getElementById('scanner-stat-subdomains').textContent = data.result.total_subdomains || 0;
                document.getElementById('scanner-stat-urls').textContent = data.result.total_urls || 0;
                document.getElementById('scanner-stat-endpoints').textContent = data.result.total_api_endpoints || 0;
                document.getElementById('scanner-stat-js').textContent = data.result.total_js_files || 0;
                document.getElementById('scanner-stat-secrets').textContent = data.result.total_secrets || 0;
                
                // Display findings
                displayFindings(data.result.findings || []);
                displaySecrets(
                    data.result.js_analysis?.secrets || [],
                    data.result.js_analysis?.endpoint_sources || {}
                );
                displayURLs(data.result.urls || []);  // Full URLs
                displayEndpoints(
                    data.result.api_endpoints || [],
                    data.result.js_analysis?.endpoint_sources || {}
                );  // API paths with sources
                displayJSFiles(data.result.js_urls || []);  // Discovered JS files
                displayNucleiFindings(
                    data.result.nuclei_findings || [],
                    data.result.nuclei_by_severity || {}
                );  // Nuclei vulnerabilities
                
                // Load chat history for this scan
                loadChatHistory(scanId);
            } catch (e) {
                alert('Error loading results: ' + e.message);
            }
        }

        function displayFindings(findings) {
            const list = document.getElementById('findingsList');
            if (!findings.length) {
                list.innerHTML = '<p class="text-gray-400">No findings</p>';
                document.getElementById('scanFindingsBtn').disabled = true;
                return;
            }
            
            const severityColors = {
                critical: 'bg-red-900 text-red-200',
                high: 'bg-orange-900 text-orange-200',
                medium: 'bg-yellow-900 text-yellow-200',
                low: 'bg-green-900 text-green-200',
                info: 'bg-gray-700 text-gray-300'
            };
            
            list.innerHTML = findings.map((f, idx) => {
                // Use title as the unique identifier for findings
                const findingId = `${f.title}__${f.severity}__${idx}`;
                const findingData = JSON.stringify(f).replace(/"/g, '&quot;');
                // Build sources section
                let sourcesHtml = '';
                
                if (f.affected_endpoints && f.affected_endpoints.length > 0) {
                    sourcesHtml += `
                        <div class="mt-3 pt-3 border-t border-gray-600">
                            <div class="text-xs font-medium text-green-400 mb-1">üìç Affected Endpoints:</div>
                            <div class="space-y-1">
                                ${f.affected_endpoints.map(endpoint => `
                                    <div class="text-xs text-gray-400 font-mono bg-gray-800 px-2 py-1 rounded break-all">${endpoint}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (f.affected_parameters && f.affected_parameters.length > 0) {
                    sourcesHtml += `
                        <div class="mt-2">
                            <div class="text-xs font-medium text-green-400 mb-1">üéØ Affected Parameters:</div>
                            <div class="flex flex-wrap gap-1">
                                ${f.affected_parameters.map(param => `
                                    <span class="text-xs text-gray-300 bg-gray-800 px-2 py-1 rounded">${param}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (f.evidence && f.evidence.length > 0) {
                    sourcesHtml += `
                        <div class="mt-2">
                            <div class="text-xs font-medium text-green-400 mb-1">üîç Evidence:</div>
                            <div class="space-y-1">
                                ${f.evidence.slice(0, 3).map(ev => `
                                    <div class="text-xs text-gray-400 font-mono bg-gray-800 px-2 py-1 rounded break-all">${ev}</div>
                                `).join('')}
                                ${f.evidence.length > 3 ? `<div class="text-xs text-gray-500 italic">+${f.evidence.length - 3} more...</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="glass-light p-4 rounded-lg border border-gray-700 flex items-start space-x-3">
                        <input type="checkbox" class="finding-checkbox item-checkbox mt-1" data-value="${findingId}" data-finding="${findingData}" data-idx="${idx}">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold">${f.title}</h4>
                                <span class="px-2 py-1 rounded text-xs ${severityColors[f.severity] || severityColors.info}">
                                    ${f.severity.toUpperCase()}
                                </span>
                            </div>
                            <p class="text-sm text-gray-400 mb-2">${f.description}</p>
                            <div class="text-xs text-gray-500">${f.category}</div>
                            ${sourcesHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('scanFindingsBtn').disabled = false;
            setupCheckboxListeners('finding');
        }

        function displaySecrets(secrets, endpoint_sources) {
            const list = document.getElementById('secretsList');
            if (!secrets.length) {
                list.innerHTML = '<p class="text-gray-400">No secrets found</p>';
                document.getElementById('scanSecretsBtn').disabled = true;
                return;
            }
            
            const severityColors = {
                'CRITICAL': 'critical-tag',
                'HIGH': 'high-tag',
                'MEDIUM': 'bg-yellow-900 text-yellow-200',
                'LOW': 'bg-green-900 text-green-200',
                'INFO': 'bg-gray-700 text-gray-300'
            };
            
            list.innerHTML = secrets.map((s, idx) => `
                <div class="glass-light p-4 rounded-lg border border-gray-700">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" class="secret-checkbox item-checkbox mt-1" data-value="${s.value}" data-idx="${idx}">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-red-400">${s.type}</h4>
                                <span class="px-2 py-1 rounded text-xs ${severityColors[s.severity] || severityColors.INFO}">${s.severity}</span>
                            </div>
                            <p class="text-sm terminal-text bg-black bg-opacity-50 p-2 rounded mb-2 overflow-x-auto break-all">${s.value}</p>
                            ${s.js_file ? `
                                <div class="flex items-center space-x-2 text-xs mb-1">
                                    <span class="source-tag">üìÅ ${s.js_file.split('/').pop()}</span>
                                    ${s.line_number ? `<span class="text-gray-500">Line ${s.line_number}</span>` : ''}
                                </div>
                            ` : ''}
                            <p class="text-xs text-gray-500 mt-2">${(s.context || '').substring(0, 100)}...</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('scanSecretsBtn').disabled = false;
            setupCheckboxListeners('secret');
        }

        function displayURLs(urls) {
            const list = document.getElementById('urlsList');
            if (!urls.length) {
                list.innerHTML = '<p class="text-gray-400">No URLs found</p>';
                return;
            }
            
            list.innerHTML = urls.slice(0, 500).map(u => {
                const url = typeof u === 'string' ? u : u.url;
                const method = typeof u === 'object' ? (u.method || 'GET') : 'GET';
                const status = typeof u === 'object' ? u.status_code : null;
                const source = typeof u === 'object' ? u.source : 'unknown';
                
                return `
                    <div class="glass-light p-2 rounded-lg border border-gray-700 flex items-center space-x-3">
                        <div class="flex-1 flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-1">
                                ${status ? `<span class="text-green-400 font-bold w-12 text-xs">${status}</span>` : '<span class="text-gray-500 w-12 text-xs">-</span>'}
                                <span class="text-green-400 font-bold w-16 text-xs">${method}</span>
                                <span class="terminal-text flex-1 break-all text-xs">${url}</span>
                            </div>
                            <span class="source-tag ml-3">${source}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayEndpoints(endpoints, endpointSources = {}) {
            const list = document.getElementById('endpointsList');
            if (!endpoints.length) {
                list.innerHTML = '<p class="text-gray-400">No API endpoints found</p>';
                document.getElementById('scanEndpointsBtn').disabled = true;
                return;
            }
            
            // Endpoints are now just strings (API paths)
            list.innerHTML = endpoints.slice(0, 500).map((path, idx) => {
                // Get source information
                const sources = endpointSources[path] || [];
                const sourceInfo = sources.length > 0 
                    ? `<div class="text-xs text-gray-500 mt-1">from: ${sources[0]} ${sources.length > 1 ? `(matches: ${sources.length})` : ''}</div>`
                    : '';
                
                return `
                    <div class="glass-light p-3 rounded-lg border border-gray-700 flex items-start space-x-3">
                        <input type="checkbox" class="endpoint-checkbox item-checkbox mt-1" data-value="${path}" data-idx="${idx}">
                        <div class="flex-1">
                            <span class="terminal-text break-all">${path}</span>
                            ${sourceInfo}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('scanEndpointsBtn').disabled = false;
            setupCheckboxListeners('endpoint');
        }

        function displayJSFiles(jsUrls) {
            const list = document.getElementById('jsFilesList');
            if (!jsUrls || !jsUrls.length) {
                list.innerHTML = '<p class="text-gray-400">No JS files found</p>';
                document.getElementById('scanJsFilesBtn').disabled = true;
                return;
            }
            
            list.innerHTML = jsUrls.slice(0, 500).map((url, idx) => {
                // Extract filename from URL
                const filename = url.split('/').pop().split('?')[0] || url;
                return `
                    <div class="glass-light p-3 rounded-lg border border-gray-700 flex items-start space-x-3">
                        <input type="checkbox" class="jsfile-checkbox item-checkbox mt-1" data-value="${url}" data-idx="${idx}">
                        <div class="flex-1">
                            <span class="terminal-text text-xs break-all">${url}</span>
                        </div>
                        <a href="${url}" target="_blank" class="text-green-400 hover:text-green-300 text-xs whitespace-nowrap mt-1">
                            üîó Open
                        </a>
                    </div>
                `;
            }).join('');
            
            document.getElementById('scanJsFilesBtn').disabled = false;
            setupCheckboxListeners('jsfile');
        }

        function displayNucleiFindings(findings, bySeverity) {
            const list = document.getElementById('nucleiList');
            const stats = document.getElementById('nucleiStats');
            
            if (!findings || !findings.length) {
                list.innerHTML = '<p class="text-gray-400">No vulnerabilities found</p>';
                stats.classList.add('hidden');
                return;
            }
            
            // Update stats
            stats.classList.remove('hidden');
            document.getElementById('nucleiCritical').textContent = bySeverity['CRITICAL'] || 0;
            document.getElementById('nucleiHigh').textContent = bySeverity['HIGH'] || 0;
            document.getElementById('nucleiMedium').textContent = bySeverity['MEDIUM'] || 0;
            document.getElementById('nucleiLow').textContent = bySeverity['LOW'] || bySeverity['INFO'] || 0;
            
            const severityColors = {
                'CRITICAL': 'bg-red-900 text-red-200',
                'HIGH': 'bg-orange-900 text-orange-200',
                'MEDIUM': 'bg-yellow-900 text-yellow-200',
                'LOW': 'bg-green-900 text-green-200',
                'INFO': 'bg-gray-700 text-gray-300'
            };
            
            list.innerHTML = findings.map(f => {
                const extracted = f.extracted_results && f.extracted_results.length > 0
                    ? `<div class="mt-2 text-xs"><strong>Extracted:</strong> ${f.extracted_results.join(', ')}</div>`
                    : '';
                    
                return `
                    <div class="glass-light p-4 rounded-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-red-400">${f.template_name}</h4>
                            <span class="px-2 py-1 rounded text-xs ${severityColors[f.severity] || severityColors.INFO}">
                                ${f.severity}
                            </span>
                        </div>
                        <p class="text-sm terminal-text text-gray-300 mb-2">Template: <span class="text-green-400">${f.template_id}</span></p>
                        <p class="text-sm terminal-text bg-black bg-opacity-50 p-2 rounded mb-2 overflow-x-auto break-all">${f.matched_url}</p>
                        ${f.matcher_name ? `<div class="text-xs text-gray-500">Matcher: ${f.matcher_name}</div>` : ''}
                        ${extracted}
                    </div>
                `;
            }).join('');
        }

        // Chat history management
        let chatController = null;
        
        function getChatHistory(scanId) {
            const key = `chat_history_${scanId}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveChatHistory(scanId, history) {
            const key = `chat_history_${scanId}`;
            localStorage.setItem(key, JSON.stringify(history));
        }
        
        function loadChatHistory(scanId) {
            const history = getChatHistory(scanId);
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear and show intro
            chatMessages.innerHTML = `
                <div class="glass-light p-4 rounded-lg border border-gray-600">
                    <p class="text-gray-400 text-sm">Ask questions about your scan results. For example:</p>
                    <ul class="list-disc list-inside text-gray-400 text-sm mt-2">
                        <li>What are the most critical findings?</li>
                        <li>Which secrets pose the highest risk?</li>
                        <li>Summarize the attack surface</li>
                    </ul>
                </div>
            `;
            
            // Add history messages
            history.forEach(msg => {
                if (msg.role === 'user') {
                    chatMessages.innerHTML += `
                        <div class="glass-light p-3 rounded-lg border border-green-500/30">
                            <p class="text-xs font-bold text-green-400 mb-1 terminal-text">[ YOU ]</p>
                            <p class="text-sm terminal-text">${msg.content}</p>
                        </div>
                    `;
                } else {
                    chatMessages.innerHTML += `
                        <div class="glass-light p-3 rounded-lg border border-pink-500/30">
                            <p class="text-xs font-bold text-pink-400 mb-1 terminal-text">[ HACKWITHAI ]</p>
                            <p class="text-sm whitespace-pre-wrap terminal-text">${msg.content}</p>
                        </div>
                    `;
                }
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Chat form
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentScanId) {
                alert('No scan results available');
                return;
            }
            
            const question = document.getElementById('chatInput').value.trim();
            if (!question) return;
            
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatStopBtn = document.getElementById('chatStopBtn');
            const chatMessages = document.getElementById('chatMessages');
            
            // Disable input and show stop button
            chatInput.disabled = true;
            chatInput.value = '';
            chatSendBtn.classList.add('hidden');
            chatStopBtn.classList.remove('hidden');
            
            // Get history
            const history = getChatHistory(currentScanId);
            
            // Add user message
            history.push({ role: 'user', content: question, timestamp: Date.now() });
            saveChatHistory(currentScanId, history);
            
            chatMessages.innerHTML += `
                <div class="glass-light p-3 rounded-lg border border-green-500/30">
                    <p class="text-xs font-bold text-green-400 mb-1 terminal-text">[ YOU ]</p>
                    <p class="text-sm terminal-text">${question}</p>
                </div>
            `;
            
            // Add loading
            chatMessages.innerHTML += `
                <div class="glass-light p-3 rounded-lg animate-pulse-custom border border-pink-500/30" id="chatLoading">
                    <p class="text-xs text-pink-400 terminal-text">[ HACKWITHAI ] Analyzing...</p>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Create abort controller
            chatController = new AbortController();
            
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        scan_id: currentScanId, 
                        question: question,
                        model: document.getElementById('model')?.value || 'llama3.1:8b'
                    }),
                    signal: chatController.signal
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || 'Chat request failed');
                }
                
                const data = await res.json();
                document.getElementById('chatLoading')?.remove();
                
                // Validate response
                const answer = data.answer || data.response || 'No response from AI';
                
                // Add assistant message
                history.push({ role: 'assistant', content: answer, timestamp: Date.now() });
                saveChatHistory(currentScanId, history);
                
                chatMessages.innerHTML += `
                    <div class="glass-light p-3 rounded-lg border border-pink-500/30">
                        <p class="text-xs font-bold text-pink-400 mb-1 terminal-text">[ HACKWITHAI ]</p>
                        <p class="text-sm whitespace-pre-wrap terminal-text">${answer}</p>
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (e) {
                document.getElementById('chatLoading')?.remove();
                if (e.name !== 'AbortError') {
                    chatMessages.innerHTML += `
                        <div class="glass-light p-3 rounded-lg border border-red-500/30">
                            <p class="text-xs text-red-400 terminal-text">Error: ${e.message}</p>
                        </div>
                    `;
                }
            } finally {
                // Re-enable input
                chatInput.disabled = false;
                chatSendBtn.classList.remove('hidden');
                chatStopBtn.classList.add('hidden');
                chatController = null;
            }
        });
        
        // Stop button
        document.getElementById('chatStopBtn').addEventListener('click', () => {
            if (chatController) {
                chatController.abort();
                const chatInput = document.getElementById('chatInput');
                const chatSendBtn = document.getElementById('chatSendBtn');
                const chatStopBtn = document.getElementById('chatStopBtn');
                
                document.getElementById('chatLoading')?.remove();
                chatInput.disabled = false;
                chatSendBtn.classList.remove('hidden');
                chatStopBtn.classList.add('hidden');
            }
        });
        
        // Clear chat button
        document.getElementById('clearChatBtn').addEventListener('click', () => {
            if (currentScanId && confirm('Clear chat history for this scan?')) {
                localStorage.removeItem(`chat_history_${currentScanId}`);
                loadChatHistory(currentScanId);
            }
        });

        // ===== PHASE 2: Targeted Scanning Functions =====
        
        // Setup checkbox event listeners
        function setupCheckboxListeners(type) {
            const checkboxClass = type === 'secret' ? '.secret-checkbox' : type === 'endpoint' ? '.endpoint-checkbox' : type === 'jsfile' ? '.jsfile-checkbox' : '.finding-checkbox';
            const selectAllId = type === 'secret' ? 'selectAllSecrets' : type === 'endpoint' ? 'selectAllEndpoints' : type === 'jsfile' ? 'selectAllJsFiles' : 'selectAllFindings';
            
            // Individual checkboxes
            document.querySelectorAll(checkboxClass).forEach(cb => {
                cb.addEventListener('change', () => {
                    updateSelectionCount(type);
                });
            });
            
            // Select all
            const selectAll = document.getElementById(selectAllId);
            if (selectAll) {
                selectAll.removeEventListener('change', selectAll._changeHandler);
                selectAll._changeHandler = (e) => {
                    document.querySelectorAll(checkboxClass).forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    updateSelectionCount(type);
                };
                selectAll.addEventListener('change', selectAll._changeHandler);
            }
        }

        // Update selection count
        function updateSelectionCount(type) {
            const checkboxClass = type === 'secret' ? '.secret-checkbox' : type === 'endpoint' ? '.endpoint-checkbox' : type === 'jsfile' ? '.jsfile-checkbox' : '.finding-checkbox';
            const countId = type === 'secret' ? 'selectedSecretsCount' : type === 'endpoint' ? 'selectedEndpointsCount' : type === 'jsfile' ? 'selectedJsFilesCount' : 'selectedFindingsCount';
            const buttonId = type === 'secret' ? 'scanSecretsBtn' : type === 'endpoint' ? 'scanEndpointsBtn' : type === 'jsfile' ? 'scanJsFilesBtn' : 'scanFindingsBtn';
            
            const selected = document.querySelectorAll(`${checkboxClass}:checked`);
            const countSpan = document.getElementById(countId);
            const button = document.getElementById(buttonId);
            
            if (countSpan) {
                countSpan.textContent = selected.length > 0 ? `(${selected.length} selected)` : '';
            }
            
            if (button) {
                button.disabled = selected.length === 0;
            }
        }

        // Targeted scan handlers
        document.getElementById('scanSecretsBtn')?.addEventListener('click', async () => {
            await performTargetedScan('secret');
        });

        document.getElementById('scanEndpointsBtn')?.addEventListener('click', async () => {
            await performTargetedScan('endpoint');
        });

        document.getElementById('scanJsFilesBtn')?.addEventListener('click', async () => {
            await performTargetedScan('jsfile');
        });

        document.getElementById('scanFindingsBtn')?.addEventListener('click', async () => {
            await performTargetedScan('finding');
        });

        document.getElementById('runNucleiBtn')?.addEventListener('click', async () => {
            if (!currentScanId) {
                alert('No active scan. Please complete a scan first.');
                return;
            }

            const btn = document.getElementById('runNucleiBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running Nuclei...';

            try {
                const response = await fetch('/api/scan/nuclei', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scan_id: currentScanId,
                        severity: ["critical", "high", "medium"]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                if (data.error) {
                    alert(`Nuclei Error: ${data.error}`);
                } else {
                    displayNucleiFindings(data.findings, data.by_severity);
                    alert(`Nuclei scan complete! Found ${data.total_findings} vulnerabilities.`);
                }
            } catch (error) {
                console.error('Nuclei scan error:', error);
                alert(`Nuclei scan failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Run Nuclei Scan';
            }
        });

        // Perform targeted scan
        async function performTargetedScan(type) {
            const checkboxClass = type === 'secret' ? '.secret-checkbox' : type === 'endpoint' ? '.endpoint-checkbox' : type === 'jsfile' ? '.jsfile-checkbox' : '.finding-checkbox';
            const selected = Array.from(document.querySelectorAll(`${checkboxClass}:checked`))
                .map(cb => cb.dataset.value);
            
            if (selected.length === 0) {
                alert('Please select at least one item to scan');
                return;
            }
            
            // Show modal
            const modal = document.getElementById('targetedScanModal');
            const loading = document.getElementById('targetedScanLoading');
            const results = document.getElementById('targetedScanResults');
            
            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            
            try {
                const response = await fetch('/api/scan/targeted', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scan_id: currentScanId,
                        target_type: type,
                        target_items: selected,
                        focus: 'security',
                        model: document.getElementById('modelSelect')?.value || 'llama3.1:8b'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                // Display results
                loading.classList.add('hidden');
                results.classList.remove('hidden');
                
                document.getElementById('targetedItemsCount').textContent = data.items_analyzed || 0;
                document.getElementById('targetedJsCount').textContent = data.js_files_analyzed?.length || 0;
                
                // Display JS files
                const jsFilesDiv = document.getElementById('targetedJsFiles');
                if (data.js_files_analyzed && data.js_files_analyzed.length > 0) {
                    jsFilesDiv.innerHTML = '<p class="text-gray-400 mb-1">JS Files Analyzed:</p>' +
                        data.js_files_analyzed.map(f => `
                            <div class="source-tag inline-block mr-2 mb-1">${f.split('/').pop()}</div>
                        `).join('');
                }
                
                // Display analysis
                const analysisDiv = document.getElementById('targetedAnalysisContent');
                analysisDiv.innerHTML = `<pre class="whitespace-pre-wrap terminal-text text-sm">${data.analysis}</pre>`;
                
            } catch (error) {
                console.error('Targeted scan error:', error);
                alert('Targeted scan failed: ' + error.message);
                modal.classList.add('hidden');
            }
        }

        // Close targeted scan modal
        document.getElementById('closeTargetedModal')?.addEventListener('click', () => {
            document.getElementById('targetedScanModal').classList.add('hidden');
        });

        // Search functionality
        function setupSearch(searchInputId, listId) {
            const searchInput = document.getElementById(searchInputId);
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const list = document.getElementById(listId);
                const items = list.querySelectorAll('.glass-light, .glass');
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(query)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Setup search bars when tabs are loaded
        setTimeout(() => {
            setupSearch('secretSearch', 'secretsList');
            setupSearch('urlSearch', 'urlsList');
            setupSearch('endpointSearch', 'endpointsList');
            setupSearch('jsFileSearch', 'jsFilesList');
            setupSearch('findingSearch', 'findingsList');
        }, 1000);

        // Create matrix rain effect
        function createMatrixRain() {
            const matrixDiv = document.getElementById('matrixRain');
            if (!matrixDiv) return;
            
            matrixDiv.innerHTML = ''; // Clear existing
            const chars = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
            const columns = Math.floor(window.innerWidth / 20);
            
            for (let i = 0; i < columns; i++) {
                const column = document.createElement('div');
                column.className = 'matrix-column';
                column.style.left = (i * 20) + 'px';
                column.style.animationDelay = (Math.random() * 2) + 's';
                column.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                let text = '';
                for (let j = 0; j < 20; j++) {
                    text += chars[Math.floor(Math.random() * chars.length)] + '<br>';
                }
                column.innerHTML = text;
                matrixDiv.appendChild(column);
            }
        }

        // Update scanner stats from websocket data
        function updateScannerStats(data) {
            if (data.result) {
                document.getElementById('scanner-stat-subdomains').textContent = data.result.total_subdomains || 0;
                document.getElementById('scanner-stat-urls').textContent = data.result.total_urls || 0;
                document.getElementById('scanner-stat-endpoints').textContent = data.result.total_api_endpoints || 0;
                document.getElementById('scanner-stat-js').textContent = data.result.total_js_files || 0;
                document.getElementById('scanner-stat-secrets').textContent = data.result.total_secrets || 0;
            }
        }

        // Load Previous Scan functionality
        document.getElementById('loadScanBtn').addEventListener('click', async () => {
            document.getElementById('loadScanModal').classList.remove('hidden');
            
            try {
                const res = await fetch('/api/scans/list');
                const data = await res.json();
                
                const listDiv = document.getElementById('previousScansList');
                
                if (data.scans.length === 0) {
                    listDiv.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üì≠</div>
                            <p>No previous scans found</p>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = data.scans.map(scan => `
                    <div class="glass-light p-4 rounded-lg border border-gray-700 hover:border-green-500 transition cursor-pointer scan-item"
                         data-scan-id="${scan.scan_id}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-green-400 font-bold terminal-text">üéØ ${scan.target_domain}</span>
                                    <span class="text-xs text-gray-400">${scan.status.toUpperCase()}</span>
                                </div>
                                <div class="grid grid-cols-5 gap-2 text-xs">
                                    <div>
                                        <span class="text-gray-400">Subs:</span>
                                        <span class="text-green-400 font-bold ml-1">${scan.stats.subdomains || 0}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">URLs:</span>
                                        <span class="text-green-400 font-bold ml-1">${scan.stats.urls || 0}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">APIs:</span>
                                        <span class="text-green-400 font-bold ml-1">${scan.stats.endpoints || 0}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">JS:</span>
                                        <span class="text-green-400 font-bold ml-1">${scan.stats.js_files || 0}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Secrets:</span>
                                        <span class="text-pink-400 font-bold ml-1">${scan.stats.secrets || 0}</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    üìÖ ${new Date(scan.completed_at).toLocaleString()}
                                </div>
                            </div>
                            <button class="hacker-button px-3 py-2 text-xs ml-4 load-scan-btn"
                                    data-scan-id="${scan.scan_id}">
                                LOAD
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.load-scan-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const scanId = btn.dataset.scanId;
                        await loadScan(scanId);
                    });
                });
                
                document.querySelectorAll('.scan-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const scanId = item.dataset.scanId;
                        await loadScan(scanId);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load scans:', error);
                document.getElementById('previousScansList').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <p>Failed to load scans</p>
                    </div>
                `;
            }
        });

        async function loadScan(scanId) {
            document.getElementById('loadScanModal').classList.add('hidden');
            
            try {
                const res = await fetch(`/api/scan/${scanId}/result`);
                const data = await res.json();
                
                currentScanId = scanId;
                sessionStorage.setItem('currentScanId', scanId);
                
                // Hide empty state and show results
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('statsPanelRight').classList.remove('hidden');
                document.getElementById('resultsPanel').classList.remove('hidden');
                document.getElementById('rightPlaceholder')?.classList.add('hidden');
                document.getElementById('openChatBtn')?.classList.remove('hidden');
                document.body.classList.remove('landing');
                
                // Update stats
                document.getElementById('stat-subdomains-right').textContent = data.result.total_subdomains || 0;
                document.getElementById('stat-urls-right').textContent = data.result.total_urls || 0;
                document.getElementById('stat-endpoints-right').textContent = data.result.total_api_endpoints || 0;
                document.getElementById('stat-js-right').textContent = data.result.total_js_files || 0;
                document.getElementById('stat-secrets-right').textContent = data.result.total_secrets || 0;
                
                // Display findings
                displayFindings(data.result.findings || []);
                displaySecrets(
                    data.result.js_analysis?.secrets || [],
                    data.result.js_analysis?.endpoint_sources || {}
                );
                displayURLs(data.result.urls || []);
                displayEndpoints(
                    data.result.api_endpoints || [],
                    data.result.js_analysis?.endpoint_sources || {}
                );
                displayJSFiles(data.result.js_urls || []);
                displayNucleiFindings(
                    data.result.nuclei_findings || [],
                    data.result.nuclei_by_severity || {}
                );
                
                // Load chat history for this scan
                loadChatHistory(scanId);
                
                // Show success message
                alert(`‚úÖ Loaded scan: ${data.result.target_domain}`);
                
            } catch (error) {
                console.error('Failed to load scan:', error);
                alert('‚ùå Failed to load scan: ' + error.message);
            }
        }

        // Close load scan modal
        document.getElementById('closeLoadScanModal')?.addEventListener('click', () => {
            document.getElementById('loadScanModal').classList.add('hidden');
        });

        // Floating chat button handlers
        document.getElementById('openChatBtn')?.addEventListener('click', () => {
            document.getElementById('chatModal').classList.remove('hidden');
        });

        document.getElementById('closeChatModal')?.addEventListener('click', () => {
            document.getElementById('chatModal').classList.add('hidden');
        });

        // Close chat modal when clicking outside
        document.getElementById('chatModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'chatModal') {
                document.getElementById('chatModal').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
